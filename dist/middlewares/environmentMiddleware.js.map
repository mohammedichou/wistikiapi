{"version":3,"sources":["middlewares/environmentMiddleware.js"],"names":["req","res","next","debug","url","process","env","NODE_ENV","startsWith","headers","ip","config","swagger","firewall","allow","_","indexOf","errors","Unavailable","require"],"mappings":";;;;;;kBAKe,UAAUA,GAAV,EAAeC,GAAf,EAAoBC,IAApB,EAA0B;AACxCC,OAAM,eAAN,EAAuBH,IAAII,GAA3B;AACA,KAAGC,QAAQC,GAAR,CAAYC,QAAZ,IAAwB,aAA3B,EACC,OAAOL,MAAP;;AAED,KAAIF,IAAII,GAAJ,IAAWJ,IAAII,GAAJ,CAAQI,UAAR,CAAmB,UAAnB,CAAf,EAA+C;AAC9CL,QAAM,WAAN,EAAmBH,GAAnB;AACAG,QAAM,mBAAN,EAA2BH,IAAIS,OAA/B;AACAN,QAAM,cAAN,EAAsBH,IAAIU,EAA1B;AACAP,QAAM,8BAAN,EAAsCH,IAAIS,OAAJ,CAAY,iBAAZ,CAAtC;AACA,MAAIE,iBAAOC,OAAP,IACHD,iBAAOC,OAAP,CAAeC,QADZ,IAEHF,iBAAOC,OAAP,CAAeC,QAAf,CAAwBC,KAFzB,EAGE;AACD,OAAIC,iBAAEC,OAAF,CAAUL,iBAAOC,OAAP,CAAeC,QAAf,CAAwBC,KAAlC,EAAyCd,IAAIU,EAA7C,KAAoD,CAAC,CAArD,IACHK,iBAAEC,OAAF,CAAUL,iBAAOC,OAAP,CAAeC,QAAf,CAAwBC,KAAlC,EAAyCd,IAAIS,OAAJ,CAAY,iBAAZ,CAAzC,KAA4E,CAAC,CAD9E,EAEE;AACDN,UAAM,iBAAN;AACA,WAAOD,KAAK,IAAIe,yBAAOC,WAAX,CAAuB,iBAAvB,CAAL,CAAP;AACA;AAED;AAED;AACDhB;AAEA,C;;AA/BD;;;;AACA;;;;AACA;;;;;;AACA,IAAMC,QAAQgB,QAAQ,OAAR,EAAiB,gCAAjB,CAAd","file":"environmentMiddleware.js","sourcesContent":["import errors from 'feathers-errors';\nimport config from '../config';\nimport _ from 'lodash';\nconst debug = require('debug')('darwin:middlewares:environment');\n\nexport default function (req, res, next) {\n\tdebug('request url: ', req.url);\n\tif(process.env.NODE_ENV == \"development\")\n\t\treturn next();\n\n\tif (req.url && req.url.startsWith('/swagger')) {\n\t\tdebug('request: ', req);\n\t\tdebug('request headers: ', req.headers);\n\t\tdebug('request ip: ', req.ip);\n\t\tdebug('request x-forwarded-for ip: ', req.headers['x-forwarded-for']);\n\t\tif (config.swagger &&\n\t\t\tconfig.swagger.firewall &&\n\t\t\tconfig.swagger.firewall.allow\n\t\t) {\n\t\t\tif (_.indexOf(config.swagger.firewall.allow, req.ip) == -1 &&\n\t\t\t\t_.indexOf(config.swagger.firewall.allow, req.headers['x-forwarded-for']) == -1\n\t\t\t) {\n\t\t\t\tdebug('page restricted');\n\t\t\t\treturn next(new errors.Unavailable('Page restricted'));\n\t\t\t}\n\n\t\t}\n\n\t}\n\tnext();\n\n}\n"],"sourceRoot":"/opt/atlassian/pipelines/agent/build/src"}