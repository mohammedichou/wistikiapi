{"version":3,"sources":["services/wistikis/recovery.js"],"names":["debug","require","Service","create","data","params","Wistiki","cache","findById","sn","wistikiModel","errors","NotFound","compareMsnCipher","msn_cipher","BadRequest","resetWistiki","save","cipher","getRecoveryCipher","recovery_token","toString"],"mappings":";;;;;;;;;;;;;;AAAA;;;;AACA;;;;AAEA,IAAMA,QAAQC,QAAQ,OAAR,EAAiB,mCAAjB,CAAd;;AAEA,IAAMC,UAAU;AACRC,QADQ;AAAA,yGACDC,IADC,EACKC,MADL;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBAEeC,YAAQC,KAAR,GAAgBC,QAAhB,CAAyBH,OAAOI,EAAhC,CAFf;;AAAA;AAENC,0BAFM;;AAAA,kBAGPA,YAHO;AAAA;AAAA;AAAA;;AAAA,oBAIJ,IAAIC,gBAAOC,QAAX,CAAoB,oBAApB,EAA0C,EAAED,QAAQ,cAAYN,OAAOI,EAAnB,gBAAV,EAA1C,CAJI;;AAAA;AAAA,kBAOPC,aAAaG,gBAAb,CAA8BT,KAAKU,UAAnC,CAPO;AAAA;AAAA;AAAA;;AAAA,oBAQJ,IAAIH,gBAAOI,UAAX,CAAsB,yBAAtB,EAAiD,EAAEJ,QAAQ,CAAC,qBAAD,CAAV,EAAjD,CARI;;AAAA;;AAWZD,2BAAaM,YAAb;AACAN,2BAAaH,KAAb,GAAqBU,IAArB;;AAZY,+CAcL,EAAEC,QAAQR,aAAaS,iBAAb,CAA+Bf,KAAKgB,cAApC,EAAoDC,QAApD,CAA6D,KAA7D,CAAV,EAdK;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA,CAAhB;;kBAkBenB,O","file":"recovery.js","sourcesContent":["import errors from 'feathers-errors/lib/index';\nimport { Wistiki } from '../../db';\n\nconst debug = require('debug')('darwin:services:wistikis:recovery');\n\nconst Service = {\n  async create(data, params) {\n    const wistikiModel = await Wistiki.cache().findById(params.sn);\n    if (!wistikiModel) {\n      throw new errors.NotFound('RESOURCE_NOT_FOUND', { errors: [`Wistiki ${params.sn} not found`] });\n    }\n\n    if (!wistikiModel.compareMsnCipher(data.msn_cipher)) {\n      throw new errors.BadRequest('OPERATION_NOT_PERMITTED', { errors: ['MSN Cipher mismatch'] });\n    }\n\n    wistikiModel.resetWistiki();\n    wistikiModel.cache().save();\n\n    return { cipher: wistikiModel.getRecoveryCipher(data.recovery_token).toString('hex') };\n  },\n};\n\nexport default Service;\n"],"sourceRoot":"/opt/atlassian/pipelines/agent/build/src"}