{"version":3,"sources":["modules/errors/handler.js"],"names":["_","require","fs","path","html","readFileSync","resolve","__dirname","toString","environment","debug","escapeHTML","String","replace","fourOhFour","req","res","next","errors","NotFound","handler","err","GeneralError","constructor","name","oldError","message","stack","code","statusCode","status","app","logger","error","url","format","get","undefined","redirect","split","slice","map","v","join","errorPage","send","json","exports","module","config","defaults","enable","use","types"],"mappings":"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","file":"handler.js","sourcesContent":["/*\n * feathers-errors\n * https://github.com/feathersjs/feathers-errors\n *\n * Copyright (c) 2014 Eric Kryski\n * Licensed under the MIT license.\n */\n\n'use strict';\n\nvar _ = require('lodash');\nvar fs = require('fs');\nvar path = require('path');\nimport errors from 'feathers-errors/lib/index';\n\nvar html = fs.readFileSync(path.resolve(__dirname, '..', '..', '..', 'static', 'html', 'error', 'error.html')).toString();\nvar environment = require('../../config');\n\nconst debug = require('debug')('darwin:errors:handler');\n/**\n * Escape the given string of `html`.\n *\n * @param {String} html\n * @return {String}\n * @api private\n */\nvar escapeHTML = function (html) {\n\treturn String(html)\n\t\t.replace(/&(?!\\w+;)/g, '&amp;')\n\t\t.replace(/</g, '&lt;')\n\t\t.replace(/>/g, '&gt;')\n\t\t.replace(/\"/g, '&quot;');\n};\n\n/**\n * Method for a 404 middleware\n * See http://expressjs.com/guide.html#error-handling\n * @param  {Error} err - An error\n * @param  {Object} req - the request object\n * @param  {Object} res - the response object\n * @param  {Function} next - callback to call for next step in middleware chain\n */\nvar fourOhFour = function (req, res, next) {\n\tnext(new errors.NotFound('Page not found.'));\n};\n\n/**\n * The error handler middleware.\n * See http://expressjs.com/guide.html#error-handling\n * @param  {Error} err - An error\n * @param  {Object} req - the request object\n * @param  {Object} res - the response object\n * @param  {Function} next - callback to call for next step in middleware chain\n *\n */\n\n/* jshint unused:false */\nvar handler = function (err, req, res, next) {\n\tif (typeof err === 'string') {\n\t\terr = new errors.GeneralError(err);\n\t}\n\telse if (!(err.constructor.name != 'FeathersError')) {\n\t\tvar oldError = err;\n\t\terr = new errors.GeneralError(oldError.message);\n\n\t\tif (oldError.stack) {\n\t\t\terr.stack = oldError.stack;\n\t\t}\n\t}\n\n\t// Don't show stack trace if it is a 404 error\n\tif (err.code === 404) {\n\t\terr.stack = null;\n\t}\n\n\tvar statusCode = typeof err.code === 'number' ? err.code : 500;\n\n\tres.status(statusCode);\n\n\tif (req.app.logger && typeof req.app.logger.error === 'function') {\n\t\treq.app.logger.error(err.code + ' - ' + req.url, err.stack || err);\n\t}\n\telse if (typeof req.app.error === 'function') {\n\t\treq.app.error(err.code + ' - ' + req.url, err.stack || err);\n\t}\n\tif (!environment.debug)\n\t\terr.stack = null;\n\tres.format({\n\t\t'text/html': function () {\n\t\t\t// If we have a rendering engine don't show the\n\t\t\t// default feathers error page.\n\t\t\t// TODO (EK): We should let people specify this instead\n\t\t\t// of making a shitty assumption.\n\t\t\tif (req.app.get('view engine') !== undefined) {\n\t\t\t\tif (err.code === 404) {\n\t\t\t\t\treturn res.redirect('/404');\n\t\t\t\t}\n\n\t\t\t\treturn res.redirect('/500');\n\t\t\t}\n\n\t\t\tvar stack = (err.stack || '')\n\t\t\t\t.split('\\n')\n\t\t\t\t.slice(1)\n\t\t\t\t.map(function (v) {\n\t\t\t\t\treturn '<li>' + v + '</li>';\n\t\t\t\t})\n\t\t\t\t.join('');\n\n\t\t\tvar errorPage = html\n\t\t\t\t.replace('{stack}', stack)\n\t\t\t\t.replace('{title}', err.message)\n\t\t\t\t.replace('{statusCode}', err.code)\n\t\t\t\t.replace(/\\{error\\}/g, escapeHTML(err.toString().replace(/\\n/g, '<br/>')));\n      debug('text/html error', errorPage);\n\t\t\tres.send(errorPage);\n\t\t},\n\n\t\t'application/json': function () {\n      const error = {\n        'code': err.code,\n        'name': err.name,\n        'message': err.message,\n        'errors': err.errors || {}\n      };\n      debug('application/json error', JSON.stringify(error, null, 2));\n      res.json(error);\n\t\t},\n\n\t\t'text/plain': function () {\n      debug('text/plain error', err.message);\n\t\t\tres.send(err.message);\n\t\t}\n\t});\n};\n\nexports = module.exports = function (config) {\n\tif (typeof config === 'function') {\n\t\thandler = config;\n\t\tconfig = {};\n\t}\n\n\tconfig = _.defaults({}, config, {\n\t\thandler: handler,\n\t\tfourOhFour: fourOhFour\n\t});\n\n\treturn function () {\n\t\tvar app = this;\n\n\t\t// Enable the errors Plugin\n\t\tapp.enable('feathers errors');\n\n\t\t// Set the error handlers\n\t\tapp.use(config.fourOhFour).use(config.handler);\n\n\t\t// Set the available errors on the app for convenience\n\t\tapp.errors = errors;\n\t};\n};\n\nexports.fourOhFour = fourOhFour;\nexports.handler = handler;\nexports.types = errors;\n"],"sourceRoot":"/opt/atlassian/pipelines/agent/build/src"}