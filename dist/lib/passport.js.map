{"version":3,"sources":["lib/passport.js"],"names":["_","require","session","cookieParser","passport","debug","authorization","getDefaults","name","userProperty","_userProperty","createSession","getSettings","settings","defaults","result","extend","module","exports","configuration","authorizer","secret","Error","store","app","oldSetup","setup","use","initialize","req","res","next","feathers","user","apply","arguments","io","primus","socket","request","error","authorize","done"],"mappings":";;AAAA,IAAIA,IAAIC,QAAQ,QAAR,CAAR;AACA,IAAIC,UAAUD,QAAQ,iBAAR,CAAd;AACA,IAAIE,eAAeF,QAAQ,eAAR,CAAnB;AACA,IAAIG,WAAWH,QAAQ,UAAR,CAAf;AACA,IAAII,QAAQJ,QAAQ,OAAR,EAAiB,wBAAjB,CAAZ;;AAEA,IAAIK,gBAAgBL,QAAQ,cAAR,CAApB;AACA,IAAIM,cAAc,SAAdA,WAAc,GAAY;AAC7B,QAAO;AACNJ,gBAAcA,YADR;AAENC,YAAUA,QAFJ;AAGNI,QAAM,aAHA;AAINC,gBAAcL,SAASM,aAAT,IAA0B,MAJlC;AAKNC,iBAAeT;AALT,EAAP;AAOA,CARD;;AAUA,IAAIU,cAAc,SAAdA,WAAc,CAAUC,QAAV,EAAoB;AACrC,KAAIC,WAAWP,aAAf;AACA,KAAIQ,SAAS,OAAOF,QAAP,KAAoB,UAApB,GACZA,SAASC,QAAT,CADY,GACSd,EAAEgB,MAAF,CAASF,QAAT,EAAmBD,QAAnB,CADtB;;AAGA,KAAI,CAACE,OAAOb,OAAZ,EAAqB;AACpBa,SAAOb,OAAP,GAAiBa,OAAOJ,aAAP,CAAqBI,MAArB,CAAjB;AACA;;AAED,QAAOA,MAAP;AACA,CAVD;;AAYAE,OAAOC,OAAP,GAAiB,UAAUC,aAAV,EAAyB;AACzC,KAAIN,WAAWD,YAAYO,aAAZ,CAAf;AACA,KAAIC,aAAad,cAAcO,QAAd,CAAjB;;AAEA,KAAI,CAACA,SAASQ,MAAd,EAAsB;AACrB,QAAM,IAAIC,KAAJ,CAAU,kCAAV,CAAN;AACA;;AAED,KAAI,CAACT,SAASU,KAAd,EAAqB;AACpB,QAAM,IAAID,KAAJ,CAAU,gCAAV,CAAN;AACA;;AAED,QAAO,YAAY;AAClB,MAAIE,MAAM,IAAV;AACA,MAAIC,WAAWD,IAAIE,KAAnB;;AAEArB,QAAM,8BAAN;;AAEAmB,MAAIG,GAAJ,CAAQd,SAASV,YAAT,CAAsBU,SAASQ,MAA/B,CAAR,EACEM,GADF,CACMd,SAASX,OADf,EAEEyB,GAFF,CAEMd,SAAST,QAAT,CAAkBwB,UAAlB,EAFN,EAGED,GAHF,CAGMd,SAAST,QAAT,CAAkBF,OAAlB,EAHN,EAIEyB,GAJF,CAIM,UAAUE,GAAV,EAAeC,GAAf,EAAoBC,IAApB,EAA0B;AAC9B;AACAF,OAAIG,QAAJ,CAAaC,IAAb,GAAoBJ,IAAII,IAAxB;AACAF;AACA,GARF;;AAUAP,MAAIE,KAAJ,GAAY,YAAY;AACvB,OAAIX,SAASU,SAASS,KAAT,CAAe,IAAf,EAAqBC,SAArB,CAAb;AACA,OAAIC,KAAKZ,IAAIY,EAAb;AACA,OAAIC,SAASb,IAAIa,MAAjB;;AAEAhC,SAAM,mBAAN;;AAEA,OAAI+B,EAAJ,EAAQ;AACP/B,UAAM,iCAAN;AACA+B,OAAGT,GAAH,CAAO,UAAUW,MAAV,EAAkBP,IAAlB,EAAwB;AAC9BX,gBAAWkB,OAAOC,OAAlB,EAA2B,UAAUC,KAAV,EAAiBP,IAAjB,EAAuB;AACjD5B,YAAM,kCAAN,EAA0CmC,KAA1C,EAAiDP,IAAjD;;AAEA,UAAIO,KAAJ,EAAW;AACV,cAAOT,KAAKS,KAAL,CAAP;AACA;;AAEDF,aAAON,QAAP,GAAkBhC,EAAEgB,MAAF,CAAS,EAACiB,MAAMA,IAAP,EAAT,EAAuBK,OAAON,QAA9B,CAAlB;AACAD;AACA,MATD;AAUA,KAXD;AAYA;;AAED,OAAIM,MAAJ,EAAY;AACXhC,UAAM,+BAAN;AACAgC,WAAOI,SAAP,CAAiB,UAAUZ,GAAV,EAAea,IAAf,EAAqB;AACrCtB,gBAAWS,GAAX,EAAgB,UAAUW,KAAV,EAAiBP,IAAjB,EAAuB;AACtC5B,YAAM,gCAAN,EAAwCmC,KAAxC,EAA+CP,IAA/C;;AAEA,UAAIO,KAAJ,EAAW;AACV,cAAOE,KAAKF,KAAL,CAAP;AACA;;AAEDX,UAAIG,QAAJ,GAAehC,EAAEgB,MAAF,CAAS,EAACiB,MAAMA,IAAP,EAAT,EAAuBJ,IAAIG,QAA3B,CAAf;AACAU;AACA,MATD;AAUA,KAXD;AAYA;;AAED,UAAO3B,MAAP;AACA,GAxCD;AAyCA,EAzDD;AA0DA,CAtED","file":"passport.js","sourcesContent":["var _ = require('lodash');\nvar session = require('express-session');\nvar cookieParser = require('cookie-parser');\nvar passport = require('passport');\nvar debug = require('debug')('feathers-passport:main');\n\nvar authorization = require('./authorizer');\nvar getDefaults = function () {\n\treturn {\n\t\tcookieParser: cookieParser,\n\t\tpassport: passport,\n\t\tname: 'connect.sid',\n\t\tuserProperty: passport._userProperty || 'user',\n\t\tcreateSession: session\n\t};\n};\n\nvar getSettings = function (settings) {\n\tvar defaults = getDefaults();\n\tvar result = typeof settings === 'function' ?\n\t\tsettings(defaults) : _.extend(defaults, settings);\n\n\tif (!result.session) {\n\t\tresult.session = result.createSession(result);\n\t}\n\n\treturn result;\n};\n\nmodule.exports = function (configuration) {\n\tvar settings = getSettings(configuration);\n\tvar authorizer = authorization(settings);\n\n\tif (!settings.secret) {\n\t\tthrow new Error('Session secret must be provided!');\n\t}\n\n\tif (!settings.store) {\n\t\tthrow new Error('Session store must be provided');\n\t}\n\n\treturn function () {\n\t\tvar app = this;\n\t\tvar oldSetup = app.setup;\n\n\t\tdebug('setting up feathers-passport');\n\n\t\tapp.use(settings.cookieParser(settings.secret))\n\t\t\t.use(settings.session)\n\t\t\t.use(settings.passport.initialize())\n\t\t\t.use(settings.passport.session())\n\t\t\t.use(function (req, res, next) {\n\t\t\t\t// Make the Passport user also available for services\n\t\t\t\treq.feathers.user = req.user;\n\t\t\t\tnext();\n\t\t\t});\n\n\t\tapp.setup = function () {\n\t\t\tvar result = oldSetup.apply(this, arguments);\n\t\t\tvar io = app.io;\n\t\t\tvar primus = app.primus;\n\n\t\t\tdebug('running app.setup');\n\n\t\t\tif (io) {\n\t\t\t\tdebug('intializing SocketIO middleware');\n\t\t\t\tio.use(function (socket, next) {\n\t\t\t\t\tauthorizer(socket.request, function (error, user) {\n\t\t\t\t\t\tdebug('authorizer for SocketIO returned', error, user);\n\n\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\treturn next(error);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tsocket.feathers = _.extend({user: user}, socket.feathers);\n\t\t\t\t\t\tnext();\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (primus) {\n\t\t\t\tdebug('intializing Primus middleware');\n\t\t\t\tprimus.authorize(function (req, done) {\n\t\t\t\t\tauthorizer(req, function (error, user) {\n\t\t\t\t\t\tdebug('authorizer for Primus returned', error, user);\n\n\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\treturn done(error);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treq.feathers = _.extend({user: user}, req.feathers);\n\t\t\t\t\t\tdone();\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn result;\n\t\t};\n\t};\n};\n"],"sourceRoot":"/opt/atlassian/pipelines/agent/build/src"}